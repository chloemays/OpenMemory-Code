#!/bin/bash
#
# OpenMemory + AI Agents - Project Watcher Launcher
#
# This script starts the project auto-detection watcher service.
# It can be run manually or as a system service.
#
# Usage:
#   openmemory-watch [start|stop|restart|status]
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Determine global directory
if [ -n "${OPENMEMORY_GLOBAL_DIR}" ]; then
    GLOBAL_DIR="${OPENMEMORY_GLOBAL_DIR}"
else
    GLOBAL_DIR="${HOME}/.openmemory-global"
fi

WATCHER_DIR="${GLOBAL_DIR}/ai-agents-template/enforcement/watcher"
WATCHER_SCRIPT="${WATCHER_DIR}/project-watcher.ts"
PID_FILE="${GLOBAL_DIR}/watcher/watcher.pid"
LOG_FILE="${GLOBAL_DIR}/watcher/watcher.log"

# Create watcher directory if needed
mkdir -p "${GLOBAL_DIR}/watcher"

# Function to check if watcher is running
is_running() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            return 0
        else
            # PID file exists but process is not running
            rm -f "$PID_FILE"
            return 1
        fi
    fi
    return 1
}

# Function to start watcher
start_watcher() {
    if is_running; then
        echo -e "${YELLOW}Watcher is already running (PID: $(cat "$PID_FILE"))${NC}"
        return 0
    fi

    echo -e "${BLUE}Starting OpenMemory Project Watcher...${NC}"

    # Check if ts-node is available
    if ! command -v ts-node &> /dev/null; then
        echo -e "${RED}Error: ts-node not found${NC}"
        echo "Install with: npm install -g ts-node typescript"
        exit 1
    fi

    # Check if watcher script exists
    if [ ! -f "$WATCHER_SCRIPT" ]; then
        echo -e "${RED}Error: Watcher script not found: $WATCHER_SCRIPT${NC}"
        exit 1
    fi

    # Start watcher in background
    nohup ts-node "$WATCHER_SCRIPT" >> "$LOG_FILE" 2>&1 &
    local pid=$!
    echo $pid > "$PID_FILE"

    # Wait a moment to ensure it started
    sleep 2

    if is_running; then
        echo -e "${GREEN}✓ Watcher started successfully (PID: $pid)${NC}"
        echo -e "${BLUE}  Log file: $LOG_FILE${NC}"
        echo -e "${BLUE}  PID file: $PID_FILE${NC}"
        echo ""
        echo "The watcher will now monitor for new projects and initialize them automatically."
        echo "To stop: openmemory-watch stop"
    else
        echo -e "${RED}✗ Failed to start watcher${NC}"
        echo "Check log file: $LOG_FILE"
        exit 1
    fi
}

# Function to stop watcher
stop_watcher() {
    if ! is_running; then
        echo -e "${YELLOW}Watcher is not running${NC}"
        return 0
    fi

    local pid=$(cat "$PID_FILE")
    echo -e "${BLUE}Stopping OpenMemory Project Watcher (PID: $pid)...${NC}"

    kill "$pid" 2>/dev/null || true

    # Wait for process to stop
    local count=0
    while ps -p "$pid" > /dev/null 2>&1 && [ $count -lt 10 ]; do
        sleep 1
        count=$((count + 1))
    done

    if ps -p "$pid" > /dev/null 2>&1; then
        echo -e "${YELLOW}Process did not stop gracefully, forcing...${NC}"
        kill -9 "$pid" 2>/dev/null || true
    fi

    rm -f "$PID_FILE"
    echo -e "${GREEN}✓ Watcher stopped${NC}"
}

# Function to show watcher status
show_status() {
    echo -e "${BLUE}=====================================================================${NC}"
    echo -e "${BLUE}OpenMemory Project Watcher Status${NC}"
    echo -e "${BLUE}=====================================================================${NC}"
    echo ""

    if is_running; then
        local pid=$(cat "$PID_FILE")
        echo -e "${GREEN}Status: RUNNING${NC}"
        echo "PID: $pid"
        echo ""

        # Show memory usage
        if command -v ps &> /dev/null; then
            local mem=$(ps -o rss= -p "$pid" 2>/dev/null || echo "0")
            local mem_mb=$((mem / 1024))
            echo "Memory: ${mem_mb}MB"
        fi

        # Show last log entries
        if [ -f "$LOG_FILE" ]; then
            echo ""
            echo "Recent activity:"
            echo "----------------------------------------"
            tail -10 "$LOG_FILE" | sed 's/^/  /'
        fi
    else
        echo -e "${YELLOW}Status: NOT RUNNING${NC}"
        echo ""
        echo "To start: openmemory-watch start"
    fi

    echo ""
    echo -e "${BLUE}Configuration:${NC}"
    echo "  Global directory: $GLOBAL_DIR"
    echo "  Watcher script: $WATCHER_SCRIPT"
    echo "  Log file: $LOG_FILE"
    echo "  PID file: $PID_FILE"

    # Show config if available
    local config_file="${GLOBAL_DIR}/watcher/config.json"
    if [ -f "$config_file" ]; then
        echo ""
        echo "Watch paths:"
        cat "$config_file" | grep -A 10 '"watchPaths"' | grep '"' | sed 's/^/  /'
    fi

    echo ""
}

# Function to restart watcher
restart_watcher() {
    echo -e "${BLUE}Restarting OpenMemory Project Watcher...${NC}"
    stop_watcher
    sleep 1
    start_watcher
}

# Main execution
case "${1:-status}" in
    start)
        start_watcher
        ;;
    stop)
        stop_watcher
        ;;
    restart)
        restart_watcher
        ;;
    status)
        show_status
        ;;
    *)
        echo "Usage: openmemory-watch {start|stop|restart|status}"
        echo ""
        echo "Commands:"
        echo "  start   - Start the project watcher"
        echo "  stop    - Stop the project watcher"
        echo "  restart - Restart the project watcher"
        echo "  status  - Show watcher status (default)"
        exit 1
        ;;
esac

exit 0
