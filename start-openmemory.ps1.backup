#!/usr/bin/env pwsh
<#
.SYNOPSIS
    Start OpenMemory services (Backend + Context Manager + Logging API)

.DESCRIPTION
    Launches the complete OpenMemory ecosystem:
    - OpenMemory Backend (port 8080)
    - Context Manager (port 8081) - auto-started by backend
    - Logging API Server (port 8083) - for logging/tracing tools
    - MCP Server ready for Claude Code

.EXAMPLE
    .\start-openmemory.ps1
    Start all OpenMemory services

.EXAMPLE
    .\start-openmemory.ps1 -Dev
    Start in development mode (with tsx)
#>

param(
    [switch]$Dev,
    [switch]$Verbose,
    [switch]$SkipLogging
)

$ErrorActionPreference = "Stop"

# Colors
function Write-Success { param($msg) Write-Host $msg -ForegroundColor Green }
function Write-Info { param($msg) Write-Host $msg -ForegroundColor Cyan }
function Write-Warning { param($msg) Write-Host $msg -ForegroundColor Yellow }
function Write-Error { param($msg) Write-Host $msg -ForegroundColor Red }

# Banner
function Show-Banner {
    Write-Host ""
    Write-Host ("=" * 70) -ForegroundColor Cyan
    Write-Host "           OpenMemory Startup Manager" -ForegroundColor Cyan
    Write-Host ("=" * 70) -ForegroundColor Cyan
    Write-Host ""
}

# Check if a port is in use
function Test-PortInUse {
    param([int]$Port)

    $connections = Get-NetTCPConnection -State Listen -ErrorAction SilentlyContinue | Where-Object { $_.LocalPort -eq $Port }
    return $connections.Count -gt 0
}

# Kill process using a port
function Stop-ProcessOnPort {
    param([int]$Port)

    $connections = Get-NetTCPConnection -State Listen -ErrorAction SilentlyContinue | Where-Object { $_.LocalPort -eq $Port }
    foreach ($conn in $connections) {
        $process = Get-Process -Id $conn.OwningProcess -ErrorAction SilentlyContinue
        if ($process) {
            Write-Warning "Stopping existing process on port ${Port}: $($process.Name) (PID: $($process.Id))"
            Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2
        }
    }
}

# Wait for service to be ready
function Wait-ForService {
    param(
        [string]$Url,
        [int]$MaxAttempts = 30,
        [string]$ServiceName
    )

    Write-Info "Waiting for $ServiceName to be ready..."

    for ($i = 1; $i -le $MaxAttempts; $i++) {
        try {
            $response = Invoke-WebRequest -Uri $Url -Method Get -TimeoutSec 2 -ErrorAction Stop
            if ($response.StatusCode -eq 200) {
                Write-Success "✓ $ServiceName is ready!"
                return $true
            }
        }
        catch {
            if ($Verbose) {
                Write-Host "  Attempt $i/$MaxAttempts..." -ForegroundColor DarkGray
            }
        }
        Start-Sleep -Seconds 1
    }

    Write-Error "✗ $ServiceName failed to start after $MaxAttempts seconds"
    return $false
}

# Check prerequisites
function Test-Prerequisites {
    Write-Info "Checking prerequisites..."

    # Check Node.js
    try {
        $nodeVersion = node --version
        Write-Success "✓ Node.js $nodeVersion found"
    }
    catch {
        Write-Error "✗ Node.js not found. Please install Node.js from https://nodejs.org/"
        exit 1
    }

    # Check global backend
    $backendPath = "$env:USERPROFILE\.openmemory-global\backend\backend"
    if (-not (Test-Path $backendPath)) {
        Write-Error "✗ OpenMemory global backend not found at: $backendPath"
        Write-Info "Please ensure OpenMemory is properly installed."
        exit 1
    }
    Write-Success "✓ OpenMemory backend found"

    # Check if backend is built
    $distPath = Join-Path $backendPath "dist"
    if (-not (Test-Path $distPath)) {
        Write-Warning "⚠ Backend not built, building now..."
        Push-Location $backendPath
        try {
            npm run build | Out-Null
            Write-Success "✓ Backend built successfully"
        }
        catch {
            Write-Error "✗ Failed to build backend: $_"
            exit 1
        }
        finally {
            Pop-Location
        }
    }
    else {
        Write-Success "✓ Backend is built"
    }

    # Check Context Manager
    $contextManagerPath = "$env:USERPROFILE\.openmemory-global\backend\.ai-agents\context-injection\context-manager"
    if (-not (Test-Path $contextManagerPath)) {
        Write-Error "✗ Context Manager not found at: $contextManagerPath"
        exit 1
    }

    $contextManagerDist = Join-Path $contextManagerPath "dist"
    if (-not (Test-Path $contextManagerDist)) {
        Write-Warning "⚠ Context Manager not built, building now..."
        Push-Location $contextManagerPath
        try {
            npm install | Out-Null
            npm run build | Out-Null
            Write-Success "✓ Context Manager built successfully"
        }
        catch {
            Write-Error "✗ Failed to build Context Manager: $_"
            exit 1
        }
        finally {
            Pop-Location
        }
    }
    else {
        Write-Success "✓ Context Manager is built"
    }

    # Check Logging System (if not skipped)
    if (-not $SkipLogging) {
        $loggingPath = Join-Path (Get-Location) ".ai-agents/logging"
        if (Test-Path $loggingPath) {
            $loggingDist = Join-Path $loggingPath "dist"
            if (-not (Test-Path $loggingDist)) {
                Write-Warning "Logging system not built, building now..."
                Push-Location $loggingPath
                try {
                    if (-not (Test-Path "node_modules")) {
                        Write-Info "Installing logging dependencies..."
                        npm install | Out-Null
                    }
                    npm run build | Out-Null
                    Write-Success "Logging system built successfully"
                }
                catch {
                    Write-Warning "Failed to build logging system"
                    Write-Info "You can build it manually later"
                }
                finally {
                    Pop-Location
                }
            }
            else {
                Write-Success "✓ Logging system is built"
            }
        }
        else {
            Write-Warning "⚠ Logging system not found at: $loggingPath"
            Write-Info "Logging/tracing MCP tools will have limited functionality"
        }
    }

    Write-Success "✓ All prerequisites met"
    Write-Host ""
}

# Start OpenMemory
function Start-OpenMemory {
    param([switch]$DevMode)

    $backendPath = "$env:USERPROFILE\.openmemory-global\backend\backend"

    # Check if services are already running
    if (Test-PortInUse -Port 8080) {
        Write-Warning "⚠ Port 8080 is already in use"
        $response = Read-Host "Stop existing service and restart? (y/N)"
        if ($response -eq "y" -or $response -eq "Y") {
            Stop-ProcessOnPort -Port 8080
            Stop-ProcessOnPort -Port 8081
            Stop-ProcessOnPort -Port 8083
        }
        else {
            Write-Info "Keeping existing services running"
            return
        }
    }

    Write-Info "Starting OpenMemory Backend..."

    Push-Location $backendPath

    try {
        # Create log directory
        $logDir = "$env:USERPROFILE\.openmemory-global\logs"
        if (-not (Test-Path $logDir)) {
            New-Item -ItemType Directory -Path $logDir -Force | Out-Null
        }

        $logFile = Join-Path $logDir "openmemory-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"

        # Start the backend
        if ($DevMode) {
            Write-Info "Starting in development mode (tsx)..."
            Start-Process -FilePath "npm" -ArgumentList "run", "dev" -NoNewWindow -RedirectStandardOutput $logFile -RedirectStandardError $logFile
        }
        else {
            Write-Info "Starting in production mode..."
            Start-Process -FilePath "npm" -ArgumentList "start" -NoNewWindow -RedirectStandardOutput $logFile -RedirectStandardError $logFile
        }

        Write-Success "✓ Backend process started (logs: $logFile)"

        # Wait for backend to be ready
        if (-not (Wait-ForService -Url "http://localhost:8080/health" -ServiceName "OpenMemory Backend" -MaxAttempts 30)) {
            Write-Error "Failed to start OpenMemory Backend. Check logs at: $logFile"
            exit 1
        }

        # Wait for Context Manager to be ready (started automatically by backend)
        Start-Sleep -Seconds 3
        if (-not (Wait-ForService -Url "http://localhost:8081/health" -ServiceName "Context Manager" -MaxAttempts 20)) {
            Write-Warning "Context Manager may not have started. Backend is running but Context Manager is not responding."
            Write-Info "Check logs at: $logFile"
        }
    }
    finally {
        Pop-Location
    }
}

# Start Logging API Server
function Start-LoggingAPI {
    if ($SkipLogging) {
        Write-Info "Skipping Logging API server (-SkipLogging flag)"
        return
    }

    $loggingPath = Join-Path (Get-Location) ".ai-agents/logging"
    $startScript = Join-Path $loggingPath "start-logging-api.js"

    if (-not (Test-Path $startScript)) {
        Write-Warning "⚠ Logging API start script not found at: $startScript"
        Write-Info "Logging/tracing MCP tools will have limited functionality"
        return
    }

    # Check if already running
    if (Test-PortInUse -Port 8083) {
        Write-Warning "⚠ Port 8083 is already in use (Logging API)"
        $response = Read-Host "Stop existing service and restart? (y/N)"
        if ($response -eq "y" -or $response -eq "Y") {
            Stop-ProcessOnPort -Port 8083
        }
        else {
            Write-Info "Keeping existing Logging API running"
            return
        }
    }

    Write-Info "Starting Logging API Server..."

    $logDir = Join-Path $loggingPath "logs"
    if (-not (Test-Path $logDir)) {
        New-Item -ItemType Directory -Path $logDir -Force | Out-Null
    }

    $logFile = Join-Path $logDir "api-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"

    try {
        Start-Process -FilePath "node" -ArgumentList $startScript -WorkingDirectory $loggingPath -NoNewWindow -RedirectStandardOutput $logFile -RedirectStandardError $logFile
        Write-Success "✓ Logging API process started (logs: $logFile)"

        # Wait for Logging API to be ready
        Start-Sleep -Seconds 3
        if (-not (Wait-ForService -Url "http://localhost:8083/api/status" -ServiceName "Logging API" -MaxAttempts 15)) {
            Write-Warning "⚠ Logging API may not have started properly"
            Write-Info "Check logs at: $logFile"
            Write-Info "Logging/tracing MCP tools will have limited functionality"
        }
    }
    catch {
        Write-Warning "⚠ Failed to start Logging API: $_"
        Write-Info "Logging/tracing MCP tools will have limited functionality"
    }
}

# Show status and instructions
function Show-Status {
    Write-Host ""
    Write-Host ("=" * 70) -ForegroundColor Green
    Write-Success "✓ OpenMemory is running!"
    Write-Host ("=" * 70) -ForegroundColor Green
    Write-Host ""

    Write-Info "Services:"
    Write-Host "  • OpenMemory Backend:  " -NoNewline
    Write-Success "http://localhost:8080"
    Write-Host "  • Context Manager:     " -NoNewline
    Write-Success "http://localhost:8081"

    if (-not $SkipLogging -and (Test-PortInUse -Port 8083)) {
        Write-Host "  • Logging API:         " -NoNewline
        Write-Success "http://localhost:8083"
    }
    else {
        Write-Host "  • Logging API:         " -NoNewline
        Write-Warning "Not running (limited tracing functionality)"
    }

    Write-Host "  • MCP Server:          " -NoNewline
    Write-Success "Ready for Claude Code (48 tools available)"
    Write-Host ""

    Write-Info "MCP Server Configuration:"
    Write-Host "  The global MCP server 'openmemory-code-global' is configured in:"
    Write-Host "  $env:USERPROFILE\.claude.json" -ForegroundColor DarkGray
    Write-Host ""
    Write-Host "  It will automatically work with all Claude Code instances!" -ForegroundColor Green
    Write-Host ""

    Write-Info "Available MCP Tools:"
    Write-Host "  • 42 OpenMemory tools (memory, validation, learning, intelligence)"
    if (Test-PortInUse -Port 8083) {
        Write-Host "  • 6 Logging/Tracing tools " -NoNewline
        Write-Success "(FULL FUNCTIONALITY ✓)"
    }
    else {
        Write-Host "  • 6 Logging/Tracing tools " -NoNewline
        Write-Warning "(LIMITED - Logging API not running)"
    }
    Write-Host ""

    Write-Info "To stop OpenMemory:"
    Write-Host "  Run: " -NoNewline
    Write-Host ".\stop-openmemory.ps1" -ForegroundColor Yellow
    Write-Host "  Or:  " -NoNewline
    Write-Host "Kill processes on ports 8080, 8081, and 8083" -ForegroundColor Yellow
    Write-Host ""

    Write-Host ("=" * 70) -ForegroundColor Green
    Write-Host ""
}

# Main execution
try {
    Show-Banner
    Test-Prerequisites
    Start-OpenMemory -DevMode:$Dev
    Start-LoggingAPI
    Show-Status

    Write-Success "OpenMemory is ready to use with Claude Code!"
    Write-Info "Restart Claude Code CLI to use the new logging/tracing tools"
}
catch {
    Write-Error "Error: $_"
    Write-Host $_.ScriptStackTrace -ForegroundColor DarkGray
    exit 1
}
